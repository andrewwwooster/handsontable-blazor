@page "/"
@using System.Text.Json
@using HandsontableBlazor
@using HandsontableBlazor.Interop
@inject IJSRuntime JSRuntime

<PageTitle>Handsontable</PageTitle>

<InputSelect @bind-Value="_actionMethod">
    <option>Alter</option>
    <option>GetCellMeta</option>
    <option>SetCellData</option>
    <option>SetCellMeta</option>
</InputSelect>

@if (_actionMethod == "Alter")
{
    <div>
        <InputSelect @bind-Value="_alterAction">
            <option>insert_row_above</option>
            <option>insert_row_below</option>
            <option>remove_row</option>
            <option>insert_col_start</option>
            <option>insert_col_end</option>
            <option>remove_col</option>
        </InputSelect>

        Visual Index: <InputNumber @bind-Value="_actionRow"/>
        Amount: <InputNumber @bind-Value="_actionColumn"/>

        <button 
            @onclick='() => _handsontable.HandsontableJsInterop!.Alter(_alterAction, _actionRow, _actionColumn)'>
            Apply
        </button>
    </div>
}
else if (_actionMethod == "GetCellMeta")
{
    <div>
        Row: <InputNumber @bind-Value="_actionRow"/>
        Col: <InputNumber @bind-Value="_actionColumn"/>
        <button 
            @onclick="@(async () => {
                var data = await _handsontable.HandsontableJsInterop!.GetCellMeta(_actionRow, _actionColumn);
                AppendToEventLog("GetCellMeta", data);
            })">
            Apply
        </button>
    </div>
}
else if (_actionMethod == "SetCellData")
{
    <div>
        Row: <InputNumber CssStyle="width: 4em" @bind-Value="_actionRow"/>
        Col: <InputNumber @bind-Value="_actionColumn"/>
        Value: <InputText @bind-Value="_actionValue"/>
        <button @onclick="() => _handsontable.HandsontableJsInterop!.SetDataAtCell(_actionRow, _actionColumn, _actionValue)">Apply</button>
    </div>
}
else if (_actionMethod == "SetCellMeta")
{
    <div>
        Row: <InputNumber @bind-Value="_actionRow"/>
        Col: <InputNumber @bind-Value="_actionColumn"/>
        Key: <InputText @bind-Value="_actionKey"/>
        Value: <InputText @bind-Value="_actionValue"/>
        <button @onclick="() => _handsontable.HandsontableJsInterop!.SetCellMeta(_actionRow, _actionColumn, _actionKey, _actionValue)">Apply</button>
    </div>
}

<label>
    <input type="checkbox" value="@_onAfterChangeToggle" @onchange='(e) => OnToggleHook<Hooks.AfterChangeArgs>("afterChange", e)'/>
    OnAfterChange
</label>
<label>
    <input type="checkbox" value="@_onAfterSelectionToggle" @onchange='(e) => OnToggleHook<Hooks.AfterSelectionArgs>("afterSelection", e)'/>
    OnAfterSelection
</label>
<label>
    <input type="checkbox" value="@_onAfterSelectionEndToggle" @onchange='(e) => OnToggleHook<Hooks.AfterSelectionEndArgs>("afterSelectionEnd", e)'/>
    OnAfterSelectionEnd
</label>


<div style="border: 1px solid black;">
    <Handsontable 
            Id="hot" 
            ConfigurationOptions="@_configurationOptions" 
            @ref="_handsontable" />
</div>

<InputTextArea @bind-Value="_eventLog" style="height: 20em; width: 60em; white-space: pre; overflow: auto;" scrollTop="1000em" readonly="true"/>

@code
{
    Handsontable _handsontable = null!;
    private HandsontableBlazor.ConfigurationOptions? _configurationOptions = null;

    private string _actionMethod = "SetCellData";
    private int _actionRow = 0;
    private int _actionColumn = 0;
    private string _actionKey = "";
    private string _actionValue = "";
    private HandsontableJsInterop.AlterActionEnum _alterAction = HandsontableJsInterop.AlterActionEnum.insert_row_above;

    private bool _onAfterChangeToggle = true;
    private bool _onAfterSelectionToggle = true;
    private bool _onAfterSelectionEndToggle = true;

    private string _eventLog = "";
   
    protected override void OnInitialized ()
    {
         _configurationOptions = new HandsontableBlazor.ConfigurationOptions 
         {
            DataArrayOfArrays =  [
                [ 1, "12!", "13" ],
                [ 21, "22!", "23" ],
                [ 31, "32!", "33" ]
            ],
            /*
            DataArrayOfObjects =  {
                new Dictionary<string, object> { 
                    { "A", 11 }, { "B", "12!" }, { "b", "13" } 
                },
                new Dictionary<string, object> { 
                    { "A", 21 }, { "B", "22!" }, { "b", "23" } 
                },
                new Dictionary<string, object> { 
                    { "A", 31 }, { "B", "32!" }, { "b", "33" } 
                }
            },
            */
            Cell = [
                new ConfigurationOptions.HtCell(1,2) { ReadOnly = true },
                new ConfigurationOptions.HtCell(2,2) { ReadOnly = true },
            ],
            ColHeaders = new string[] { "A", "B", "C" },
            RendererCallback = OnRenderCallback,
            RowHeaders = true,
            Height = 200,
            Width = 300
        };
    }

    private void AppendToEventLog(string name, object properties)
    {
        var propertiesJson = JsonSerializer.Serialize(properties);
        _eventLog = name + ": " + propertiesJson + "\n"
            + _eventLog;
        StateHasChanged();              // Required because event was initiated by JS.
    }
    
    private async Task OnHookCallback(Hooks.BaseHookArgs args)
    {
        var json = JsonSerializer.Serialize((object) args);
        _eventLog = $"{json}\n"
            + _eventLog;
        StateHasChanged(); 
        await Task.CompletedTask;
    }

    private async Task OnRenderCallback(Renderer.RendererArgs args)
    {
        await args.Td.Attr("style", "background-color: yellow; color: #000000;");
        await args.Td.Text(args.Value.ToString() ?? "");
    }

    private async Task OnToggleHook<HookArgsT>(string hookName, ChangeEventArgs args)
        where HookArgsT : Hooks.BaseHookArgs
    {
        if ((bool) args.Value!)
        {
            await _handsontable.HandsontableJsInterop!.AddHook<HookArgsT>(hookName, OnHookCallback);
        }
    }
}
